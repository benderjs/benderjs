#!/usr/bin/env node
var argParser = require('nomnom'),
    path = require('path'),
    broadway = require('broadway'),

    dir = '../lib/',

    applications = require(dir + 'applications'),
    cache = require(dir + 'cache'),
    clients = require(dir + 'clients'),
    conf = require(dir + 'config'),
    constants = require(dir + 'constants'),
    files = require(dir + 'files'),
    logger = require(dir + 'logger'),
    plugins = require(dir + 'plugins'),
    server = require(dir + 'server'),
    sockets = require(dir + 'sockets'),
    tests = require(dir + 'tests'),
    utils = require(dir + 'utils'),

    log = logger.create('cli');

argParser.command('init')
    .callback(initialize)
    .help('Initialize Bender.js for this directory');

argParser.command('server')
    .callback(startServer)
    .option('port', {
        abbr: 'p',
        default: constants.PORT,
        help: 'Port on which the server will run'
    })
    .option('hostname', {
        abbr: 'H', // YEAH... should be "h" but it's reserved for nomnom's help
        default: constants.HOSTNAME,
        help: 'Hostname used to run server'
    })
    .option('config', {
        abbr: 'c',
        help: 'Alternative path to Bender.js configuration file'
    })
    .help('Start Bender.js server');

argParser.command('version')
    .callback(function () {
        log.info('Bender.js v%s', constants.VERSION);
    })
    .help('Print Bender.js version');

argParser.parse();

function startServer(options) {
    var bender = new broadway.App(),
        modules = [
            utils, applications, files, cache, clients,
            constants, tests, sockets, server, plugins
        ];

    bender.use(conf, { path: path.resolve(process.cwd(), options.config || 'bender.js') });
    
    modules.forEach(function (module) { bender.use(module); });

    bender.init(function (err) {
        if (err) {
            log.error(error);
            process.exit(1);
        }

        bender.server.create().listen(options.port, options.hostname, function () {
            log.info('Bender.js v%s Server started at http://%s:%s', bender.constants.VERSION, options.hostname, options.port);
        });
    });
}

function initialize(options) {
    // TODO create config file for current directory    
}
